<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MathFlow — Learn</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            error: '#ef4444',
            bgLight: '#fafafa',
            cardLight: '#ffffff',
            bgDark: '#0f0f0f',
            cardDark: '#1a1a1a',
            textPrimaryLight: '#111827',
            textPrimaryDark: '#f9fafb',
          },
          borderRadius: { 'card': '8px', 'btn': '6px' }
        },
        fontFamily: {
          sans: ['Inter', 'ui-sans-serif', 'system-ui'],
          heading: ['Space Grotesk', 'Inter', 'ui-sans-serif']
        }
      }
    }
  </script>
  <style>
    input::placeholder { color: #9ca3af; }
    .dark input::placeholder { color: #6b7280; }
  </style>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="antialiased bg-bgLight text-textPrimaryLight" data-theme="light">
  <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:bg-white focus:px-3 focus:py-2 focus:rounded-md">Skip to content</a>

  <!-- Navigation -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 dark:bg-black/80 border-b border-gray-100 dark:border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="index.html" class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-heading">M</div>
            <div class="hidden sm:block">
              <span class="block font-heading text-lg"><p style="color:white;">MathFlow</p></span>
              <span class="text-sm text-gray-500"><p style="color:white;">Design to Learn</p></span>
            </div>
          </a>
          <nav class="hidden md:flex gap-2 ml-6" aria-label="Primary">
            <a href="index.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">Home</a>

            <a href="schedule.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">Schedule</a>
            <a href="ai-tutor.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">AI Tutor</a>
            <a href="learn.html" class="px-3 py-2 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-primary">Learn</a>
            <a href="resources.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">Resources</a>
            <a href="community.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">Community</a>
          </nav>
        </div>
        <div class="flex items-center gap-3">
          <button type="button" id="themeToggle" class="p-2 rounded-md focus-ring" aria-pressed="false" title="Toggle theme">
            <svg id="themeIcon" class="h-5 w-5 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-10.66h-1M4.34 12.34h-1M18.36 18.36l-.7-.7M6.34 6.34l-.7-.7M18.36 5.64l-.7.7M6.34 17.66l-.7.7M12 8a4 4 0 100 8 4 4 0 000-8z" />
            </svg>
          </button>
          <a href="dashboard.html" class="px-4 py-2 rounded-btn bg-primary text-white font-medium hover:opacity-90 transition">Dashboard</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="main" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Hero -->
    <div class="bg-gradient-to-r from-primary via-secondary to-accent text-white rounded-2xl p-8 mb-8 shadow-2xl">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-4xl font-heading font-bold mb-2">AI-Powered Learning</h1>
          <p class="text-white/90 text-lg">Generate custom math questions instantly with Google Gemini</p>
        </div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="grid lg:grid-cols-3 gap-6">

      <!-- Controls -->
      <div class="space-y-6">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-800">
          <h2 class="text-xl font-heading font-bold mb-4 text-gray-900 dark:text-white">Generate Questions</h2>

          <div class="space-y-4">
            <div>
              <label for="topic" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Topic</label>
              <input type="text" id="topic" name="topic" aria-label="Enter math topic" placeholder="e.g., Quadratic Equations, Derivatives, Pythagorean Theorem" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
            </div>

            <div>
              <label for="difficulty" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Difficulty Level</label>
              <input type="text" id="difficulty" name="difficulty" aria-label="Enter difficulty level" placeholder="e.g., Easy, Medium, Hard, College Level" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
            </div>

            <div>
              <label for="numQuestions" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Number of Questions</label>
              <input type="text" id="numQuestions" name="numQuestions" aria-label="Number of questions" placeholder="e.g., 5, 10, 15" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/50 focus:border-primary transition">
            </div>

            <button type="button" id="generate" class="w-full py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-xl font-bold hover:shadow-lg hover:scale-[1.02] transition-all duration-200">
              Generate with AI
            </button>
          </div>
        </div>

        <div id="stats" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-800">
          <h3 class="font-heading font-bold mb-3 text-gray-900 dark:text-white">Progress</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Correct:</span>
              <span id="correct" class="font-bold text-success">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Incorrect:</span>
              <span id="incorrect" class="font-bold text-error">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Score:</span>
              <span id="score" class="font-bold text-primary">0%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Questions -->
      <div class="lg:col-span-2">
        <div id="container" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 border border-gray-100 dark:border-gray-800 min-h-[600px]">

          <div id="empty" class="flex flex-col items-center justify-center h-full text-center py-20">
            <svg class="w-24 h-24 text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="text-xl font-heading font-bold text-gray-400 mb-2">No Questions</h3>
            <p class="text-gray-500">Generate questions to start!</p>
          </div>

          <div id="loading" class="hidden flex flex-col items-center justify-center h-full py-20">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-primary mb-6"></div>
            <p class="text-lg font-medium mb-4 text-gray-900 dark:text-white">Generating with AI...</p>

            <!-- Progress Bar -->
            <div class="w-full max-w-md">
              <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                <div id="progressBar" class="bg-gradient-to-r from-primary to-secondary h-full transition-all duration-500 ease-out" style="width: 0%"></div>
              </div>
              <div class="flex justify-between mt-2 text-sm text-gray-500 dark:text-gray-400">
                <span id="progressText">Starting...</span>
                <span id="progressPercent">0%</span>
              </div>
            </div>
          </div>

          <div id="questions" class="hidden space-y-6"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-12 border-t border-gray-100 dark:border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-md bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-center font-heading">M</div>
        <div>
          <div class="font-medium">MathFlow</div>
          <div class="text-xs text-gray-500">Made by students, for students</div>
        </div>
      </div>
      <div class="text-sm text-gray-500">&copy; <span id="year"></span> MathFlow. All rights reserved.</div>
      <div class="flex items-center gap-3">
        <a href="#" class="text-gray-500 text-sm hover:text-primary">Privacy</a>
        <a href="#" class="text-gray-500 text-sm hover:text-primary">Terms</a>
      </div>
    </div>
  </footer>

  <script src="shared.js"></script>
  <script>requireAuth();</script>
  <script>
    // ADD YOUR GOOGLE GEMINI API KEY HERE
    const key = '';

    let qs = [];
    let s = {c:0, w:0};
    let _learnTopic = '';
    let _learnDiff = '';

    document.getElementById('year').textContent = new Date().getFullYear();

    // Progress bar update function
    function updateProgress(percent, text) {
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent + '%';
      document.getElementById('progressText').textContent = text;
    }

    // Simulate realistic progress during API call
    function startProgress(apiPromise) {
      let progress = 0;
      const steps = [
        { time: 100, percent: 10, text: 'Connecting to Gemini...' },
        { time: 300, percent: 25, text: 'Analyzing request...' },
        { time: 500, percent: 40, text: 'Generating questions...' },
        { time: 800, percent: 60, text: 'Creating options...' },
        { time: 1000, percent: 75, text: 'Adding explanations...' },
        { time: 1200, percent: 85, text: 'Finalizing...' }
      ];

      let stepIndex = 0;

      const progressInterval = setInterval(() => {
        if (stepIndex < steps.length) {
          const step = steps[stepIndex];
          updateProgress(step.percent, step.text);
          stepIndex++;
        }
      }, 400);

      return apiPromise.finally(() => {
        clearInterval(progressInterval);
        updateProgress(100, 'Complete!');
      });
    }

    async function gen() {
      const topic = document.getElementById('topic').value.trim();
      const diff = document.getElementById('difficulty').value.trim();
      const num = document.getElementById('numQuestions').value.trim();

      // Validate inputs
      if (!topic || !diff || !num) {
        alert('Please fill in all fields');
        return;
      }
      _learnTopic = topic;
      _learnDiff = diff;

      document.getElementById('empty').classList.add('hidden');
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('questions').classList.add('hidden');

      // Reset progress
      updateProgress(0, 'Starting...');

      try {
        const apiCall = fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: `You are a helpful math tutor assistant. Generate ${num} questions with a difficulty level of ${diff} on the topic ${topic}. Return ONLY a JSON array with this exact format: [{"q":"question text","opts":["option A","option B","option C","option D"],"ans":"A","exp":"explanation why this is correct"}]. Do not include any markdown formatting, code blocks, asterisks (*), or bold text. Use plain text only in all question content and explanations. Return just the raw JSON array.`
              }]
            }],
            generationConfig: {
              temperature: 0.7,
              topK: 40,
              topP: 0.95
            }
          })
        });

        const res = await startProgress(apiCall);
        const data = await res.json();

        // Check for API errors
        if (data.error) {
          throw new Error(data.error.message || 'API Error');
        }

        // Check if response has expected structure
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
          throw new Error('Invalid API response. Please check your API key and try again.');
        }

        let txt = data.candidates[0].content.parts[0].text.trim();
        txt = txt.replace(/```json\n?/g, '').replace(/```\n?/g, '');
        qs = JSON.parse(txt);

        // Show parsing complete
        updateProgress(100, 'Questions ready!');
        await new Promise(resolve => setTimeout(resolve, 300));

        show();
        if (typeof logActivity === 'function') {
          logActivity('lesson', `Generated ${num} ${diff} questions on "${topic}"`);
        }
      } catch (e) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('empty').classList.remove('hidden');
        document.getElementById('empty').innerHTML = `
          <svg class="w-24 h-24 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-xl font-bold text-red-600 mb-2">Error</h3>
          <p class="text-gray-600 dark:text-gray-400">${e.message}</p>
        `;
      }
    }

    function show() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('questions').classList.remove('hidden');
      document.getElementById('stats').classList.remove('hidden');

      document.getElementById('questions').innerHTML = qs.map((q,i) => `
        <div class="p-6 border-2 rounded-2xl border-gray-100 dark:border-gray-700" id="q${i}">
          <div class="flex justify-between mb-4">
            <h3 class="font-heading font-bold text-lg text-gray-900 dark:text-white">Q${i+1}</h3>
            <span class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">Unanswered</span>
          </div>
          <p class="text-lg mb-4 text-gray-900 dark:text-white">${q.q}</p>
          <div class="space-y-2">
            ${q.opts.map((o,j) => `
              <button onclick="ans(${i},'${String.fromCharCode(65+j)}')" class="btn w-full text-left px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-primary hover:bg-primary/5 dark:hover:bg-primary/10 text-gray-900 dark:text-white transition-all duration-150">
                <span class="font-bold">${String.fromCharCode(65+j)}.</span> ${o}
              </button>
            `).join('')}
          </div>
          <div id="exp${i}" class="hidden mt-4 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
            <p class="text-sm text-blue-900 dark:text-blue-100">${q.exp}</p>
          </div>
        </div>
      `).join('');
    }

    window.ans = (i,a) => {
      const q = qs[i];
      const ok = a === q.ans;
      if (ok) {
        s.c++;
        if (typeof logActivity === 'function') {
          logActivity('lesson', `Correct answer on "${_learnTopic}" (${_learnDiff})`);
        }
      } else {
        s.w++;
      }

      const div = document.getElementById(`q${i}`);
      div.querySelectorAll('.btn').forEach(b => {
        b.disabled = true;
        const opt = b.textContent.trim()[0];
        if (opt === q.ans) b.className = 'btn w-full text-left px-4 py-3 rounded-xl border-2 !border-green-600 !bg-green-100 dark:!bg-green-900/20 !text-green-900 dark:!text-green-100';
        else if (opt === a) b.className = 'btn w-full text-left px-4 py-3 rounded-xl border-2 !border-red-600 !bg-red-100 dark:!bg-red-900/20 !text-red-900 dark:!text-red-100';
      });

      div.querySelector('span').textContent = ok ? '✓ Correct' : '✗ Wrong';
      div.querySelector('span').className = `px-3 py-1 rounded-full text-sm font-medium ${ok ? 'bg-success text-white' : 'bg-error text-white'}`;
      document.getElementById(`exp${i}`).classList.remove('hidden');

      document.getElementById('correct').textContent = s.c;
      document.getElementById('incorrect').textContent = s.w;
      const tot = s.c + s.w;
      document.getElementById('score').textContent = tot > 0 ? Math.round(s.c/tot*100) + '%' : '0%';
    };

    document.getElementById('generate').onclick = () => {
      s = {c:0, w:0};
      document.getElementById('correct').textContent = '0';
      document.getElementById('incorrect').textContent = '0';
      document.getElementById('score').textContent = '0%';
      gen();
    };

    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const body = document.body;
    let theme = localStorage.getItem('mf_theme') || 'light';

    function setTheme(x) {
      body.setAttribute('data-theme', x);
      if (x === 'dark') {
        body.classList.add('dark');
        document.documentElement.classList.add('dark');
        themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />';
        themeIcon.classList.remove('text-gray-700');
        themeIcon.classList.add('text-gray-300');
        themeToggle.setAttribute('aria-pressed', 'true');
      } else {
        body.classList.remove('dark');
        document.documentElement.classList.remove('dark');
        themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-10.66h-1M4.34 12.34h-1M18.36 18.36l-.7-.7M6.34 6.34l-.7-.7M18.36 5.64l-.7.7M6.34 17.66l-.7.7M12 8a4 4 0 100 8 4 4 0 000-8z" />';
        themeIcon.classList.remove('text-gray-300');
        themeIcon.classList.add('text-gray-700');
        themeToggle.setAttribute('aria-pressed', 'false');
      }
      localStorage.setItem('mf_theme', x);
    }

    setTheme(theme);
    themeToggle.dataset.mfInited = '1';
    themeToggle.onclick = () => setTheme(body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
  </script>
</body>
</html>
