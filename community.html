<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MathFlow — Community</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            error: '#ef4444',
            bgLight: '#fafafa',
            cardLight: '#ffffff',
            bgDark: '#0f0f0f',
            cardDark: '#1a1a1a',
            textPrimaryLight: '#111827',
            textPrimaryDark: '#f9fafb',
          },
          borderRadius: { 'card': '8px', 'btn': '6px' }
        },
        fontFamily: {
          sans: ['Inter', 'ui-sans-serif', 'system-ui'],
          heading: ['Space Grotesk', 'Inter', 'ui-sans-serif']
        }
      },
      safelist: [
        'bg-primary', 'bg-secondary', 'bg-accent', 'bg-success', 'bg-warning', 'bg-error',
        'text-primary', 'text-secondary', 'text-accent', 'text-success', 'text-warning', 'text-error',
        'border-primary', 'border-secondary', 'border-accent',
        'from-primary', 'to-secondary',
      ]
    }
  </script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="antialiased bg-bgLight text-textPrimaryLight" data-theme="light">
  <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:bg-white focus:px-3 focus:py-2 focus:rounded-md">Skip to content</a>

  <!-- Navigation -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 dark:bg-black/80 border-b border-gray-100 dark:border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="index.html" class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-heading">M</div>
            <div class="hidden sm:block">
              <span class="block font-heading text-lg text-gray-900 dark:text-white">MathFlow</span>
              <span class="text-sm text-gray-500 dark:text-white">Design to Learn</span>
            </div>
          </a>
          <nav class="hidden md:flex gap-2 ml-6" aria-label="Primary">
            <a href="index.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">Home</a>
            <a href="schedule.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">Schedule</a>
            <a href="ai-tutor.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">AI Tutor</a>
            <a href="learn.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">Learn</a>
            <a href="resources.html" class="px-3 py-2 text-sm rounded-md text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">Resources</a>
            <a href="community.html" class="px-3 py-2 text-sm rounded-md bg-gray-100 dark:bg-gray-800 text-primary">Community</a>
          </nav>
        </div>
        <div class="flex items-center gap-3">
          <button id="themeToggle" class="p-2 rounded-md focus-ring" aria-pressed="false" title="Toggle theme">
            <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-10.66h-1M4.34 12.34h-1M18.36 18.36l-.7-.7M6.34 6.34l-.7-.7M18.36 5.64l-.7.7M6.34 17.66l-.7.7M12 8a4 4 0 100 8 4 4 0 000-8z" />
            </svg>
          </button>
          <a href="dashboard.html" class="px-4 py-2 rounded-btn bg-primary text-white font-medium hover:opacity-90 transition">Dashboard</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main id="main" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Hero Banner -->
    <div class="bg-gradient-to-r from-primary via-secondary to-accent text-white rounded-2xl p-8 mb-8 shadow-2xl">
      <div class="flex items-center justify-between">
        <div>
          <div class="flex items-center gap-4 mb-3">
            <h1 class="text-4xl font-heading font-bold">Community</h1>
          </div>
          <p class="text-white/90 text-lg">Connect, collaborate, and learn together with fellow math students</p>
        </div>
        <button id="newPostBtn" class="hidden md:flex items-center gap-2 px-5 py-2.5 rounded-xl bg-white/20 hover:bg-white/30 text-white font-semibold transition">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          New Discussion
        </button>
      </div>
    </div>

    <!-- Mobile New Discussion Button -->
    <div class="md:hidden mb-6">
      <button id="newPostBtnMobile" class="w-full px-4 py-3 rounded-xl bg-gradient-to-r from-primary to-secondary text-white font-semibold flex items-center justify-center gap-2 shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all duration-200">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        New Discussion
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 mb-8 overflow-x-auto pb-2 border-b border-gray-200 dark:border-gray-700">
      <button class="community-tab tab active px-4 py-2 font-medium whitespace-nowrap" data-tab="discussions">Discussions</button>
      <button class="community-tab tab px-4 py-2 font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap" data-tab="tutors">Find Tutors</button>
      <button class="community-tab tab px-4 py-2 font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap" data-tab="groups">Study Groups</button>
      <button class="community-tab tab px-4 py-2 font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap" data-tab="leaderboard">Leaderboard</button>
    </div>

    <!-- Content Sections -->
    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Main Content Area -->
      <div class="lg:col-span-2">
        <!-- Discussions Tab -->
        <div id="discussions-content" class="tab-content">
          <!-- Filter Bar -->
          <div class="flex flex-wrap gap-2 mb-6">
            <button class="topic-filter active px-3 py-1.5 rounded-full text-sm font-medium bg-primary text-white" data-topic="all">All Topics</button>
            <button class="topic-filter px-3 py-1.5 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-topic="algebra">Algebra</button>
            <button class="topic-filter px-3 py-1.5 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-topic="geometry">Geometry</button>
            <button class="topic-filter px-3 py-1.5 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-topic="precalc">Pre-Calc</button>
            <button class="topic-filter px-3 py-1.5 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-topic="general">General</button>
          </div>

          <!-- Discussions List -->
          <div id="discussionsList" class="space-y-4"></div>
        </div>

        <!-- Tutors Tab -->
        <div id="tutors-content" class="tab-content hidden">
          <div class="mb-6">
            <div class="relative">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" id="tutorSearch" placeholder="Search tutors by name or subject..." class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
            </div>
          </div>
          <div id="tutorsList" class="grid md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Study Groups Tab -->
        <div id="groups-content" class="tab-content hidden">
          <div class="flex justify-between items-center mb-6">
            <p class="text-gray-600 dark:text-gray-400">Find or create study groups</p>
            <button id="createGroupBtn" class="px-4 py-2 rounded-xl bg-gradient-to-r from-primary to-secondary text-white text-sm font-semibold hover:opacity-90 transition shadow-lg">Create Group</button>
          </div>
          <div id="groupsList" class="space-y-4"></div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboard-content" class="tab-content hidden">
          <div class="bg-gradient-to-r from-primary to-secondary rounded-2xl p-6 text-white mb-6 shadow-2xl">
            <h2 class="text-xl font-heading font-semibold mb-2">Top Contributors This Week</h2>
            <p class="text-white/80 text-sm">Earn points by helping others, completing lessons, and hosting sessions</p>
          </div>
          <div id="leaderboardList" class="space-y-3"></div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Online Now -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900 dark:text-white">Online Now</h3>
            <span class="flex items-center gap-1 text-sm text-success">
              <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
              47 users
            </span>
          </div>
          <div id="onlineUsers" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Trending Topics -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 p-6">
          <h3 class="font-semibold text-gray-900 dark:text-white mb-4">Trending Topics</h3>
          <div class="space-y-3">
            <a href="#" class="block p-3 rounded-xl bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-100 dark:border-gray-700 transition">
              <div class="font-medium text-sm text-gray-900 dark:text-white">#quadratic-equations</div>
              <div class="text-xs text-gray-500">23 discussions</div>
            </a>
            <a href="#" class="block p-3 rounded-xl bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-100 dark:border-gray-700 transition">
              <div class="font-medium text-sm text-gray-900 dark:text-white">#circle-theorems</div>
              <div class="text-xs text-gray-500">18 discussions</div>
            </a>
            <a href="#" class="block p-3 rounded-xl bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-100 dark:border-gray-700 transition">
              <div class="font-medium text-sm text-gray-900 dark:text-white">#trig-help</div>
              <div class="text-xs text-gray-500">15 discussions</div>
            </a>
            <a href="#" class="block p-3 rounded-xl bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-100 dark:border-gray-700 transition">
              <div class="font-medium text-sm text-gray-900 dark:text-white">#study-tips</div>
              <div class="text-xs text-gray-500">12 discussions</div>
            </a>
          </div>
        </div>

        <!-- Community Stats -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 p-6">
          <h3 class="font-semibold text-gray-900 dark:text-white mb-4">Community Stats</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-gray-500 text-sm">Total Members</span>
              <span class="font-semibold text-gray-900 dark:text-white">5,247</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-500 text-sm">Discussions</span>
              <span class="font-semibold text-gray-900 dark:text-white">1,892</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-500 text-sm">Questions Answered</span>
              <span class="font-semibold text-gray-900 dark:text-white">8,431</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-500 text-sm">Active Tutors</span>
              <span class="font-semibold text-gray-900 dark:text-white">142</span>
            </div>
          </div>
        </div>

        <!-- Become a Tutor CTA -->
        <div class="bg-gradient-to-br from-accent to-success rounded-2xl p-6 text-white shadow-2xl">
          <h3 class="font-heading font-semibold text-white text-lg mb-2">Become a Tutor</h3>
          <p class="text-sm text-white/80 mb-4">Share your knowledge and help others succeed. Tutors earn recognition and unlock exclusive badges.</p>
          <button id="becomeTutorBtn" class="w-full px-4 py-2.5 rounded-xl bg-white text-accent font-semibold hover:bg-gray-50 transition">Apply Now</button>
        </div>
      </div>
    </div>
  </main>

  <!-- New Post Modal -->
  <div id="newPostModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="w-full max-w-xl bg-cardLight dark:bg-cardDark rounded-2xl shadow-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-heading font-semibold text-gray-900 dark:text-white">Start a Discussion</h3>
        <button type="button" id="closePostModal" class="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <form id="newPostForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">Title</label>
          <input type="text" id="postTitle" required class="w-full px-3 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="What's your question?">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">Topic</label>
          <select id="postTopic" class="w-full px-3 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
            <option value="algebra">Algebra</option>
            <option value="geometry">Geometry</option>
            <option value="precalc">Pre-Calculus</option>
            <option value="general">General</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">Description</label>
          <textarea id="postContent" rows="4" required class="w-full px-3 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary transition" placeholder="Describe your question in detail..."></textarea>
        </div>
        <div class="flex justify-end gap-3">
          <button type="button" id="cancelPost" class="px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 transition">Cancel</button>
          <button type="submit" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-primary to-secondary text-white font-semibold hover:opacity-90 transition">Post Discussion</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Discussion Detail Modal -->
  <div id="discussionDetailModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="w-full max-w-2xl max-h-[90vh] bg-white dark:bg-gray-900 rounded-2xl shadow-2xl flex flex-col">
      <!-- Header -->
      <div class="p-5 border-b border-gray-100 dark:border-gray-800 flex items-start justify-between gap-4">
        <div class="flex-1 min-w-0">
          <div id="detailTopic" class="flex items-center gap-2 mb-2"></div>
          <h3 id="detailTitle" class="text-xl font-heading font-bold text-gray-900 dark:text-white leading-snug"></h3>
          <div class="flex items-center gap-2 mt-2 text-sm text-gray-500 dark:text-gray-400">
            <span id="detailAuthorInitials" class="w-6 h-6 rounded-md text-white text-xs flex items-center justify-center font-semibold"></span>
            <span id="detailAuthor" class="font-medium text-gray-700 dark:text-gray-300"></span>
            <span>&bull;</span>
            <span id="detailTime"></span>
          </div>
        </div>
        <button id="closeDetailModal" class="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 hover:text-gray-700 dark:hover:text-gray-200 transition shrink-0">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Content + Replies -->
      <div class="flex-1 overflow-y-auto p-5 space-y-5">
        <div id="detailContent" class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl text-gray-700 dark:text-gray-300 text-sm leading-relaxed"></div>
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
          </svg>
          <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Replies</h4>
          <span id="detailReplyCount" class="text-xs text-gray-400 dark:text-gray-500"></span>
        </div>
        <div id="detailRepliesList" class="space-y-3"></div>
      </div>
      <!-- Reply input -->
      <div class="p-4 border-t border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 rounded-b-2xl">
        <div class="flex gap-2">
          <input type="text" id="replyInput" placeholder="Write a reply..."
            class="flex-1 px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary transition text-sm">
          <button id="submitReply" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-primary to-secondary text-white font-semibold text-sm hover:opacity-90 transition">
            Reply
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-12 border-t border-gray-100 dark:border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-md bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-center font-heading">M</div>
        <div>
          <div class="font-medium text-gray-900 dark:text-white">MathFlow</div>
          <div class="text-xs text-gray-500">Made by students, for students</div>
        </div>
      </div>
      <div class="text-sm text-gray-500">&copy; <span id="year"></span> MathFlow. All rights reserved.</div>
      <div class="flex items-center gap-3">
        <a href="#" class="text-gray-500 text-sm hover:text-primary">Privacy</a>
        <a href="#" class="text-gray-500 text-sm hover:text-primary">Terms</a>
      </div>
    </div>
  </footer>

  <script src="shared.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---- Theme Toggle ----
    (function initTheme() {
      const themeToggle = document.getElementById('themeToggle');
      const body = document.body;
      const storedTheme = localStorage.getItem('mf_theme') || 'light';
      setTheme(storedTheme);
      themeToggle.addEventListener('click', () => {
        const next = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        setTheme(next);
      });
      function setTheme(t) {
        body.setAttribute('data-theme', t);
        const themeIcon = document.querySelector('#themeIcon');
        if (t === 'dark') {
          body.classList.add('dark');
          document.documentElement.classList.add('dark');
          themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />';
          themeIcon.classList.remove('text-gray-700');
          themeIcon.classList.add('text-gray-300');
          themeToggle.setAttribute('aria-pressed', 'true');
        } else {
          body.classList.remove('dark');
          document.documentElement.classList.remove('dark');
          themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-10.66h-1M4.34 12.34h-1M18.36 18.36l-.7-.7M6.34 6.34l-.7-.7M18.36 5.64l-.7.7M6.34 17.66l-.7.7M12 8a4 4 0 100 8 4 4 0 000-8z" />';
          themeIcon.classList.remove('text-gray-300');
          themeIcon.classList.add('text-gray-700');
          themeToggle.setAttribute('aria-pressed', 'false');
        }
        localStorage.setItem('mf_theme', t);
      }
    })();

    // ---- Data ----
    const DEFAULT_DISCUSSIONS = [
      { id: 1, title: 'How do I solve this quadratic equation?', content: "I have x² + 5x + 6 = 0 and I'm not sure which method to use. Should I factor or use the quadratic formula? Any step-by-step help would be great!", topic: 'algebra', author: 'Alex Chen', authorInitials: 'AC', timestamp: new Date(Date.now() - 7200000).toISOString(), time: '2 hours ago', replies: 5, views: 42, solved: true },
      { id: 2, title: 'Circle theorem proof help needed', content: "I'm struggling with the inscribed angle theorem. Can someone explain why the inscribed angle is exactly half the central angle subtending the same arc?", topic: 'geometry', author: 'Maria Rodriguez', authorInitials: 'MR', timestamp: new Date(Date.now() - 14400000).toISOString(), time: '4 hours ago', replies: 3, views: 28, solved: false },
      { id: 3, title: 'Best way to remember trig identities?', content: "I always blank on sin²θ + cos²θ = 1 and the double-angle formulas during tests. Does anyone have good memory tricks or mnemonic devices that actually work?", topic: 'precalc', author: 'James Wilson', authorInitials: 'JW', timestamp: new Date(Date.now() - 21600000).toISOString(), time: '6 hours ago', replies: 12, views: 89, solved: true },
      { id: 4, title: 'Study group for SAT math prep', content: "Looking for motivated students to join a weekly SAT math study group. We'll cover everything from algebra to data analysis. DM me if interested — aiming for 750+!", topic: 'general', author: 'Sarah Kim', authorInitials: 'SK', timestamp: new Date(Date.now() - 86400000).toISOString(), time: '1 day ago', replies: 8, views: 156, solved: false },
      { id: 5, title: 'Factoring trinomials — step by step guide request', content: "Can someone walk me through factoring ax² + bx + c when a ≠ 1? I get confused with the AC method vs grouping. Which is faster for tests?", topic: 'algebra', author: 'David Lee', authorInitials: 'DL', timestamp: new Date(Date.now() - 86400000).toISOString(), time: '1 day ago', replies: 4, views: 67, solved: true },
      { id: 6, title: 'Understanding limits approaching infinity', content: "What does it actually mean for a limit to approach infinity? My teacher explained L'Hôpital's rule but I'm still confused about when to apply it versus direct substitution.", topic: 'precalc', author: 'Emily Chen', authorInitials: 'EC', timestamp: new Date(Date.now() - 172800000).toISOString(), time: '2 days ago', replies: 7, views: 93, solved: false },
    ];

    function loadDiscussions() {
      const stored = localStorage.getItem('mf_discussions');
      if (stored) return JSON.parse(stored);
      localStorage.setItem('mf_discussions', JSON.stringify(DEFAULT_DISCUSSIONS));
      return [...DEFAULT_DISCUSSIONS];
    }

    function saveDiscussions() {
      localStorage.setItem('mf_discussions', JSON.stringify(discussions));
    }

    // ---- Get current user from dashboard profile ----
    function getCurrentUser() {
      const profile = JSON.parse(localStorage.getItem('mf_profile') || '{}');
      if (profile && profile.name) {
        const initials = profile.initials || profile.name.split(' ').filter(Boolean).map(n => n[0]).join('').toUpperCase().slice(0, 2);
        return { name: profile.name, initials };
      }
      if (typeof userState !== 'undefined' && userState.name) {
        const name = userState.name;
        return { name, initials: name.split(' ').filter(Boolean).map(n => n[0]).join('').toUpperCase().slice(0, 2) };
      }
      return { name: 'You', initials: 'Y' };
    }

    let discussions = loadDiscussions();

    const tutors = [
      { id: 1, name: 'Alex Chen', initials: 'AC', subjects: ['Algebra', 'Pre-Calculus'], rating: 4.9, sessions: 156, rate: 'Free', online: true },
      { id: 2, name: 'Maria Rodriguez', initials: 'MR', subjects: ['Geometry', 'Algebra'], rating: 4.8, sessions: 98, rate: 'Free', online: true },
      { id: 3, name: 'James Wilson', initials: 'JW', subjects: ['Pre-Calculus', 'Trigonometry'], rating: 4.9, sessions: 203, rate: 'Free', online: false },
      { id: 4, name: 'Sarah Kim', initials: 'SK', subjects: ['Algebra', 'Geometry'], rating: 4.7, sessions: 87, rate: 'Free', online: true },
      { id: 5, name: 'David Lee', initials: 'DL', subjects: ['Pre-Calculus'], rating: 4.8, sessions: 124, rate: 'Free', online: false },
      { id: 6, name: 'Emily Chen', initials: 'EC', subjects: ['Geometry', 'Pre-Calculus'], rating: 4.9, sessions: 178, rate: 'Free', online: true },
    ];

    const studyGroups = [
      { id: 1, name: 'SAT Math Prep', members: 12, maxMembers: 15, topic: 'General', nextSession: 'Tomorrow, 4 PM', host: 'Alex Chen' },
      { id: 2, name: 'Quadratic Equations Study', members: 8, maxMembers: 10, topic: 'Algebra', nextSession: 'Friday, 3 PM', host: 'Maria Rodriguez' },
      { id: 3, name: 'Geometry Proofs Practice', members: 6, maxMembers: 8, topic: 'Geometry', nextSession: 'Saturday, 2 PM', host: 'James Wilson' },
      { id: 4, name: 'Pre-Calc Weekly Review', members: 15, maxMembers: 20, topic: 'Pre-Calculus', nextSession: 'Sunday, 5 PM', host: 'Sarah Kim' },
    ];

    const leaderboard = [
      { rank: 1, name: 'Alex Chen', initials: 'AC', points: 2450, badge: 'gold' },
      { rank: 2, name: 'Maria Rodriguez', initials: 'MR', points: 2180, badge: 'gold' },
      { rank: 3, name: 'James Wilson', initials: 'JW', points: 1920, badge: 'gold' },
      { rank: 4, name: 'Sarah Kim', initials: 'SK', points: 1750, badge: 'silver' },
      { rank: 5, name: 'David Lee', initials: 'DL', points: 1680, badge: 'silver' },
      { rank: 6, name: 'Emily Chen', initials: 'EC', points: 1540, badge: 'silver' },
      { rank: 7, name: 'Michael Brown', initials: 'MB', points: 1420, badge: 'bronze' },
      { rank: 8, name: 'Lisa Wang', initials: 'LW', points: 1380, badge: 'bronze' },
      { rank: 9, name: 'Chris Taylor', initials: 'CT', points: 1290, badge: 'bronze' },
      { rank: 10, name: 'Anna Park', initials: 'AP', points: 1150, badge: 'bronze' },
    ];

    const onlineUsers = ['AC', 'MR', 'SK', 'EC', 'JW', 'DL', 'MB', 'LW'];

    const topicColors = {
      algebra: { name: 'primary', hex: '#6366f1' },
      geometry: { name: 'secondary', hex: '#8b5cf6' },
      precalc: { name: 'accent', hex: '#06b6d4' },
      general: { name: 'warning', hex: '#f59e0b' }
    };

    let currentTopic = 'all';
    let currentTab = 'discussions';

    // ---- Render discussions ----
    function renderDiscussions() {
      const list = document.getElementById('discussionsList');
      const filtered = currentTopic === 'all' ? discussions : discussions.filter(d => d.topic === currentTopic);

      list.innerHTML = filtered.map(d => {
        const topicColor = topicColors[d.topic];
        return `
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 p-5 hover:scale-[1.01] hover:shadow-2xl transition-all duration-200 cursor-pointer" onclick="openDiscussion(${d.id})">
          <div class="flex items-start gap-4">
            <div class="w-10 h-10 rounded-xl text-white flex items-center justify-center font-semibold shrink-0 text-sm" style="background-color: ${topicColor.hex}">
              ${d.authorInitials}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-2 mb-2">
                <h3 class="font-semibold text-gray-900 dark:text-white leading-snug">${d.title}</h3>
                ${d.solved ? '<span class="px-2.5 py-0.5 text-xs rounded-full bg-success/10 text-success font-medium shrink-0">Solved</span>' : ''}
              </div>
              <div class="flex flex-wrap items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                <span>${d.author}</span>
                <span>&bull;</span>
                <span>${d.timestamp ? timeAgo(d.timestamp) : d.time}</span>
                <span>&bull;</span>
                <span class="px-2 py-0.5 rounded-full text-xs capitalize font-medium" style="background-color: ${topicColor.hex}20; color: ${topicColor.hex}">${d.topic}</span>
              </div>
              <div class="flex items-center gap-4 mt-3 text-sm text-gray-400 dark:text-gray-500">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                  </svg>
                  ${d.replies} replies
                </span>
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  ${d.views} views
                </span>
              </div>
            </div>
          </div>
        </div>
        `;
      }).join('');
    }

    // ---- Render tutors ----
    function renderTutors() {
      const list = document.getElementById('tutorsList');
      const searchTerm = document.getElementById('tutorSearch').value.toLowerCase();
      const filtered = tutors.filter(t =>
        t.name.toLowerCase().includes(searchTerm) ||
        t.subjects.some(s => s.toLowerCase().includes(searchTerm))
      );

      list.innerHTML = filtered.map(t => `
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 p-5 hover:scale-[1.02] transition-all duration-200">
          <div class="flex items-start gap-3">
            <div class="relative shrink-0">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-center font-semibold">
                ${t.initials}
              </div>
              ${t.online ? '<span class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-success rounded-full border-2 border-white dark:border-gray-800"></span>' : ''}
            </div>
            <div class="flex-1">
              <div class="flex items-center justify-between mb-1">
                <h4 class="font-semibold text-gray-900 dark:text-white">${t.name}</h4>
                <div class="flex items-center gap-1 text-warning text-sm font-medium">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                  </svg>
                  ${t.rating}
                </div>
              </div>
              <div class="flex flex-wrap gap-1 mb-2">
                ${t.subjects.map(s => `<span class="px-2 py-0.5 text-xs rounded-full bg-primary/10 text-primary font-medium">${s}</span>`).join('')}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mb-3">${t.sessions} sessions completed</div>
              <button class="w-full px-3 py-2 rounded-xl text-sm font-semibold transition ${t.online ? 'bg-gradient-to-r from-primary to-secondary text-white hover:opacity-90' : 'border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:border-primary hover:text-primary'}" onclick="requestTutor(${t.id})">
                ${t.online ? 'Request Session' : 'Schedule Session'}
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ---- Render study groups ----
    function renderGroups() {
      const list = document.getElementById('groupsList');
      list.innerHTML = studyGroups.map(g => {
        const topicColor = topicColors[g.topic.toLowerCase()] || { hex: '#6b7280' };
        const isFull = g.members >= g.maxMembers;
        return `
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 p-5 hover:scale-[1.01] transition-all duration-200">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h4 class="font-semibold text-gray-900 dark:text-white mb-1">${g.name}</h4>
              <p class="text-sm text-gray-500 dark:text-gray-400">Hosted by ${g.host}</p>
            </div>
            <span class="px-2.5 py-0.5 text-xs rounded-full font-medium" style="background-color: ${topicColor.hex}20; color: ${topicColor.hex}">${g.topic}</span>
          </div>
          <div class="flex items-center gap-4 mb-4 text-sm text-gray-500 dark:text-gray-400">
            <span class="flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              ${g.members}/${g.maxMembers} members
            </span>
            <span class="flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              ${g.nextSession}
            </span>
          </div>
          <button class="w-full px-4 py-2.5 rounded-xl text-sm font-semibold transition ${isFull ? 'bg-gray-100 dark:bg-gray-700 text-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-primary to-secondary text-white hover:opacity-90 hover:scale-[1.02]'}" ${isFull ? 'disabled' : ''} onclick="joinGroup(${g.id})">
            ${isFull ? 'Group Full' : 'Join Group'}
          </button>
        </div>
        `;
      }).join('');
    }

    // ---- Render leaderboard ----
    function renderLeaderboard() {
      const list = document.getElementById('leaderboardList');
      const badgeColors = {
        gold:   { hex: '#f59e0b' },
        silver: { hex: '#9ca3af' },
        bronze: { hex: '#d97706' }
      };

      list.innerHTML = leaderboard.map(l => {
        const badge = badgeColors[l.badge];
        return `
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-800 p-4 flex items-center gap-4 ${l.rank <= 3 ? 'ring-2' : ''}" ${l.rank <= 3 ? `style="ring-color: ${badge.hex}"` : ''}>
          <div class="w-9 h-9 rounded-xl flex items-center justify-center font-bold text-sm shrink-0" style="background-color: ${l.rank <= 3 ? badge.hex : '#e5e7eb'}; color: ${l.rank <= 3 ? 'white' : '#4b5563'}">
            ${l.rank}
          </div>
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-center font-semibold text-sm shrink-0">
            ${l.initials}
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white text-sm">${l.name}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">${l.points.toLocaleString()} points</div>
          </div>
          ${l.rank <= 3 ? `
            <svg class="w-6 h-6 shrink-0" fill="currentColor" viewBox="0 0 20 20" style="color: ${badge.hex}">
              <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clip-rule="evenodd"/>
            </svg>
          ` : ''}
        </div>
        `;
      }).join('');
    }

    // ---- Render online users ----
    function renderOnlineUsers() {
      const container = document.getElementById('onlineUsers');
      container.innerHTML = onlineUsers.map(u => `
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-center text-xs font-semibold" title="${u}">
          ${u}
        </div>
      `).join('');
    }

    // ---- Tab switching ----
    document.querySelectorAll('.community-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.community-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`${tab.dataset.tab}-content`).classList.remove('hidden');
        currentTab = tab.dataset.tab;
      });
    });

    // ---- Topic filtering ----
    document.querySelectorAll('.topic-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.topic-filter').forEach(b => {
          b.classList.remove('active', 'bg-primary', 'text-white');
          b.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        });
        btn.classList.add('active', 'bg-primary', 'text-white');
        btn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        currentTopic = btn.dataset.topic;
        renderDiscussions();
      });
    });

    // ---- Tutor search ----
    document.getElementById('tutorSearch').addEventListener('input', debounce(renderTutors, 300));

    // ---- Modal handling ----
    const newPostModal = document.getElementById('newPostModal');
    const newPostBtn = document.getElementById('newPostBtn');
    const newPostBtnMobile = document.getElementById('newPostBtnMobile');
    const closePostModal = document.getElementById('closePostModal');
    const cancelPost = document.getElementById('cancelPost');
    const newPostForm = document.getElementById('newPostForm');

    function openModal() {
      if (newPostModal) {
        newPostModal.classList.remove('hidden');
        newPostModal.classList.add('flex');
      }
    }

    function closeModal() {
      if (newPostModal) {
        newPostModal.classList.add('hidden');
        newPostModal.classList.remove('flex');
      }
      if (newPostForm) newPostForm.reset();
    }

    if (newPostBtn) newPostBtn.addEventListener('click', openModal);
    if (newPostBtnMobile) newPostBtnMobile.addEventListener('click', openModal);
    if (closePostModal) closePostModal.addEventListener('click', closeModal);
    if (cancelPost) cancelPost.addEventListener('click', closeModal);
    if (newPostModal) {
      newPostModal.addEventListener('click', (e) => {
        if (e.target === newPostModal) closeModal();
      });
    }

    newPostForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = document.getElementById('postTitle').value.trim();
      const topic = document.getElementById('postTopic').value;
      const content = document.getElementById('postContent').value.trim();

      const user = getCurrentUser();
      const newDiscussion = {
        id: Date.now(),
        title,
        content,
        topic,
        author: user.name,
        authorInitials: user.initials,
        timestamp: new Date().toISOString(),
        time: 'Just now',
        replies: 0,
        views: 1,
        solved: false
      };

      discussions.unshift(newDiscussion);
      saveDiscussions();

      // Notify other open tabs instantly
      if (window._mfChannel) {
        window._mfChannel.postMessage({ type: 'new_discussion', discussion: newDiscussion });
      }

      closeModal();
      renderDiscussions();
      showToast('Discussion posted!', 'success');
    });

    // ---- Discussion detail ----
    let currentDiscussionId = null;

    function loadReplies(discussionId) {
      const all = JSON.parse(localStorage.getItem('mf_replies') || '{}');
      return all[String(discussionId)] || [];
    }

    function saveReply(discussionId, reply) {
      const all = JSON.parse(localStorage.getItem('mf_replies') || '{}');
      const key = String(discussionId);
      if (!all[key]) all[key] = [];
      all[key].push(reply);
      localStorage.setItem('mf_replies', JSON.stringify(all));
      return all[key];
    }

    function renderReplies(replies) {
      const list = document.getElementById('detailRepliesList');
      if (!replies.length) {
        list.innerHTML = '<p class="text-sm text-gray-400 italic text-center py-6">No replies yet — be the first to reply!</p>';
        return;
      }
      const disc = discussions.find(d => d.id === currentDiscussionId);
      const col = (disc && topicColors[disc.topic]) ? topicColors[disc.topic].hex : '#6366f1';
      list.innerHTML = replies.map(r => `
        <div class="flex gap-3">
          <div class="w-8 h-8 rounded-lg text-white flex items-center justify-center text-xs font-semibold shrink-0" style="background-color:${col}">
            ${r.authorInitials}
          </div>
          <div class="flex-1 bg-gray-50 dark:bg-gray-800 rounded-xl p-3">
            <div class="flex items-center gap-2 mb-1">
              <span class="font-semibold text-sm text-gray-900 dark:text-white">${r.author}</span>
              <span class="text-xs text-gray-400 dark:text-gray-500">${timeAgo(r.timestamp)}</span>
            </div>
            <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">${r.content}</p>
          </div>
        </div>
      `).join('');
    }

    function openDiscussion(id) {
      const discussion = discussions.find(d => d.id === id);
      if (!discussion) return;

      currentDiscussionId = id;
      discussion.views = (discussion.views || 0) + 1;
      saveDiscussions();

      const topicColor = topicColors[discussion.topic] || { hex: '#6366f1' };

      document.getElementById('detailTitle').textContent = discussion.title;
      document.getElementById('detailAuthor').textContent = discussion.author;
      document.getElementById('detailTime').textContent = discussion.timestamp ? timeAgo(discussion.timestamp) : discussion.time;
      document.getElementById('detailContent').textContent = discussion.content || 'No description provided.';

      const initEl = document.getElementById('detailAuthorInitials');
      initEl.textContent = discussion.authorInitials;
      initEl.style.backgroundColor = topicColor.hex;

      const topicEl = document.getElementById('detailTopic');
      topicEl.innerHTML = `<span class="px-2.5 py-0.5 rounded-full text-xs font-medium capitalize" style="background-color:${topicColor.hex}20;color:${topicColor.hex}">${discussion.topic}</span>`;
      if (discussion.solved) {
        topicEl.innerHTML += ' <span class="px-2.5 py-0.5 text-xs rounded-full bg-success/10 text-success font-medium">Solved</span>';
      }

      const replies = loadReplies(id);
      document.getElementById('detailReplyCount').textContent = `(${replies.length})`;
      renderReplies(replies);

      const modal = document.getElementById('discussionDetailModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.getElementById('replyInput').value = '';
      document.getElementById('replyInput').focus();
    }

    function closeDetailModal() {
      const modal = document.getElementById('discussionDetailModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      currentDiscussionId = null;
      renderDiscussions();
    }

    // ---- Reply submission ----
    function submitReply() {
      if (!currentDiscussionId) return;
      const input = document.getElementById('replyInput');
      const content = input.value.trim();
      if (!content) return;

      const user = getCurrentUser();
      const reply = {
        id: Date.now(),
        author: user.name,
        authorInitials: user.initials,
        content,
        timestamp: new Date().toISOString()
      };

      const allReplies = saveReply(currentDiscussionId, reply);
      const disc = discussions.find(d => d.id === currentDiscussionId);
      if (disc) {
        disc.replies = allReplies.length;
        saveDiscussions();
      }

      document.getElementById('detailReplyCount').textContent = `(${allReplies.length})`;
      renderReplies(allReplies);
      input.value = '';

      if (window._mfChannel) {
        window._mfChannel.postMessage({ type: 'new_reply', discussionId: currentDiscussionId, reply });
      }
      showToast('Reply posted!', 'success');
    }

    document.getElementById('submitReply').addEventListener('click', submitReply);
    document.getElementById('replyInput').addEventListener('keydown', e => { if (e.key === 'Enter') submitReply(); });
    document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
    document.getElementById('discussionDetailModal').addEventListener('click', e => { if (e.target.id === 'discussionDetailModal') closeDetailModal(); });

    // ---- BroadcastChannel: real-time cross-tab sync ----
    if ('BroadcastChannel' in window) {
      window._mfChannel = new BroadcastChannel('mf_community');
      window._mfChannel.addEventListener('message', e => {
        const { type, discussion, discussionId, reply } = e.data;
        if (type === 'new_discussion' && discussion) {
          discussions.unshift(discussion);
          renderDiscussions();
          showToast('New discussion just posted!', 'info');
        } else if (type === 'new_reply' && reply) {
          if (currentDiscussionId === discussionId) {
            const replies = loadReplies(discussionId);
            renderReplies(replies);
            document.getElementById('detailReplyCount').textContent = `(${replies.length})`;
          }
          const disc = discussions.find(d => d.id === discussionId);
          if (disc) {
            const replies = loadReplies(discussionId);
            disc.replies = replies.length;
            renderDiscussions();
          }
        }
      });
    }

    // ---- Action handlers ----

    function requestTutor(id) {
      const tutor = tutors.find(t => t.id === id);
      showToast(`Request sent to ${tutor.name}!`, 'success');
    }

    function joinGroup(id) {
      const group = studyGroups.find(g => g.id === id);
      if (group.members < group.maxMembers) {
        group.members++;
        renderGroups();
        showToast(`Joined ${group.name}!`, 'success');
      }
    }

    document.getElementById('createGroupBtn').addEventListener('click', () => {
      showToast('Group creation coming soon!', 'info');
    });

    document.getElementById('becomeTutorBtn').addEventListener('click', () => {
      showToast('Tutor application submitted!', 'success');
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { closeModal(); closeDetailModal(); }
    });

    // ---- Initialize ----
    renderDiscussions();
    renderTutors();
    renderGroups();
    renderLeaderboard();
    renderOnlineUsers();
  </script>
</body>
</html>
